@if (selectedMediaItem(); as media) {
  <div class="p-4 sm:p-6 lg:grid lg:grid-cols-12 lg:gap-6 xl:gap-8">
    <!-- Main Content: Player and Info -->
    <div class="lg:col-span-8 xl:col-span-9">
      <!-- 
        Player Container
        Uses [ngClass] to switch between embedded (relative) and cinema mode (fixed).
        This ensures the iframe is NEVER destroyed/recreated, preventing reload.
      -->
      <div
        [ngClass]="{
          'relative mb-4 rounded-lg aspect-[16/9] overflow-hidden': !isMaximized(),
          'fixed inset-0 z-[9999] w-screen h-screen bg-black flex items-center justify-center': isMaximized()
        }"
        class="bg-black transition-all duration-300"
      >
        <!-- The actual Iframe Player -->
        <iframe
          class="w-full h-full"
          [src]="safeConstructedPlayerUrl()"
          (load)="onPlayerIframeLoad()"
          [class.invisible]="loadingTrailer() || !playerUrl()"
          title="Video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen
        >
        </iframe>
  
        <!-- Close Button (Only visible in Cinema Mode) -->
        @if (isMaximized()) {
          <div class="absolute top-4 right-4 z-[10000]">
            <button
              (click)="closeMaximize(); $event.stopPropagation()"
              class="flex items-center justify-center w-12 h-12 bg-zinc-900/90 hover:bg-zinc-800 rounded-full transition-colors shadow-lg backdrop-blur-sm border border-zinc-700/50"
              title="Exit Cinema Mode (ESC)"
            >
              <span class="material-symbols-outlined text-2xl text-white">close</span>
            </button>
          </div>
        }
  
        @if (loadingTrailer() || !playerUrl()) {
        <!-- Loading Facade (Thumbnail and Spinner) -->
        <div class="w-full h-full absolute inset-0">
          @if(thumbnailUrl(); as thumb) {
          <img
            [ngSrc]="thumb"
            [alt]="media.media_type === 'movie' ? media.title : media.name"
            class="w-full h-full object-cover"
            width="1280"
            height="720"
            priority
          />
          }
          <div
            class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"
          ></div>
  
          @if (loadingTrailer()) {
          <!-- Loading Spinner -->
          <div
            class="absolute inset-0 flex items-center justify-center bg-black/50"
          >
            <div
              class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-red-500"
            ></div>
          </div>
          } @else if (selectedPlayer() === 'YouTube' && !playerUrl()) {
          <!-- No Trailer Available Message -->
          <div
            class="absolute inset-0 flex items-center justify-center bg-zinc-900/80"
          >
            <div class="text-center p-4">
              <span
                class="material-symbols-outlined mx-auto text-5xl text-zinc-600"
              >
                videocam_off
              </span>
              <p class="text-zinc-400 mt-4">No YouTube trailer available.</p>
            </div>
          </div>
          }
        </div>
        }
        
        <!-- Next Episode Overlay -->
        @if (showNextEpisodeButton()) {
          <div class="absolute top-8 right-8 z-50 animate-fade-in">
            <button
              (click)="onNextEpisodeClick()"
              class="group relative overflow-hidden bg-zinc-900/90 hover:bg-zinc-800 text-white px-6 py-3 rounded-lg font-medium shadow-lg transition-all duration-300 flex items-center gap-3 border border-zinc-700/50 backdrop-blur-sm"
            >
              <!-- Progress Bar Background (only when counting down) -->
              @if (autoNextState() === 'counting_down') {
                <div 
                  class="absolute inset-0 bg-white/10 transition-all duration-1000 ease-linear origin-left"
                  [style.width.%]="(3 - autoNextCountdown()) / 3 * 100"
                ></div>
              }
  
              <!-- Icon -->
              <span class="material-symbols-outlined text-2xl group-hover:scale-110 transition-transform">
                skip_next
              </span>
  
              <!-- Text -->
              <div class="flex flex-col items-start z-10">
                <span class="text-sm uppercase tracking-wider text-zinc-400 text-[10px] leading-none mb-1">Up Next</span>
                <span class="font-bold leading-none">
                  @if (autoNextState() === 'counting_down') {
                    Playing in {{ autoNextCountdown() }}...
                  } @else {
                    Next Episode
                  }
                </span>
              </div>
  
              <!-- Cancel Button (only when counting down) -->
              @if (autoNextState() === 'counting_down') {
                <div 
                  (click)="$event.stopPropagation(); cancelAutoNext()"
                  class="ml-3 p-1 hover:bg-white/20 rounded-full transition-colors"
                  title="Cancel Auto-Play"
                >
                  <span class="material-symbols-outlined text-lg">close</span>
                </div>
              }
            </button>
          </div>
        }
      </div>
      
      <!-- Video Info -->
      <div>
        <app-video-info
          [media]="media"
          [genreMap]="genreMap()"
          [currentEpisode]="currentEpisode()"
          [videoDetails]="videoDetails()"
          [currentTime]="currentPlaybackTime()"
          (episodeSelected)="onEpisodeSelected($event)"
          (refreshPlayer)="onRefreshPlayer()"
          (maximizePlayerOutput)="onMaximizePlayer()"
        >
        </app-video-info>
      </div>
    </div>
  
    <!-- Sidebar: Playlist or Related Videos -->
    <div class="lg:col-span-4 xl:col-span-3 mt-8 lg:mt-0">
      @if (playlist(); as pl) {
      <div class="mb-8">
        <app-video-player-playlist
          [playlist]="pl"
          [currentMediaId]="media.id"
          (selectMedia)="onSelectMedia($event)"
          (close)="onClosePlaylist()"
        />
      </div>
      }
      <app-related-videos
        [currentMedia]="media"
        [genreMap]="genreMap()"
        (selectMedia)="onSelectMedia($event)"
      >
      </app-related-videos>
    </div>
  </div>
  } @else {
  <div class="flex justify-center items-center h-96">
    <div
      class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-red-500"
    ></div>
  </div>
  }
