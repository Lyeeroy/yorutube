@if (selectedMediaItem(); as media) {
<div class="p-4 sm:p-6 lg:grid lg:grid-cols-12 lg:gap-6 xl:gap-8">
  <!-- Main Content: Player and Info -->
  <div class="lg:col-span-8 xl:col-span-9">
    <!-- 
        Player Container
        Uses [ngClass] to switch between embedded (relative) and cinema mode (fixed).
        This ensures the iframe is NEVER destroyed/recreated, preventing reload.
      -->
    <div
      [ngClass]="{
        'relative mb-4 rounded-lg aspect-[16/9] overflow-hidden':
          !isMaximized(),
        'fixed inset-0 z-[9999] bg-black flex items-center justify-center':
          isMaximized()
      }"
      class="bg-black transition-all duration-300"
    >
      <!-- The actual Iframe Player -->
      <iframe
        class="w-full h-full"
        [src]="safeConstructedPlayerUrl()"
        (load)="onPlayerIframeLoad()"
        [class.invisible]="loadingTrailer() || !playerUrl() || iframeLoading()"
        title="Video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin"
        allowfullscreen
      >
      </iframe>

      <!-- Close Button (Only visible in Cinema Mode) -->
      @if (isMaximized()) {
      <div class="absolute top-2 sm:top-4 right-2 sm:right-4 z-[10000]">
        <button
          (click)="closeMaximize(); $event.stopPropagation()"
          class="flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-full transition-colors shadow-lg backdrop-blur-sm"
          title="Exit Cinema Mode (ESC)"
        >
          <span class="material-symbols-outlined text-xl sm:text-2xl text-white"
            >close</span
          >
        </button>
      </div>
      } @if (loadingTrailer() || !playerUrl() || iframeLoading()) {
      <!-- Skeleton Loading State -->
      @if (loadingTrailer() || iframeLoading()) {
      <div class="w-full h-full absolute inset-0 bg-zinc-800 animate-pulse">
        <!-- Optional: Subtle play button placeholder -->
      </div>
      } @else if (selectedPlayer() === 'YouTube' && !playerUrl()) {
      <!-- No Trailer Available Message -->
      <div
        class="absolute inset-0 flex items-center justify-center bg-zinc-900"
      >
        <div class="text-center p-4">
          <span
            class="material-symbols-outlined mx-auto text-5xl text-zinc-600"
          >
            videocam_off
          </span>
          <p class="text-zinc-400 mt-4">No YouTube trailer available.</p>
        </div>
      </div>
      } }



      <!-- Next Episode Overlay -->
      @if (showNextEpisodeButton()) {
      <div
        class="absolute top-3 sm:top-6 md:top-8 lg:top-14 right-0 z-50 flex flex-col items-end overflow-hidden py-2 sm:py-4 pointer-events-none w-[320px] sm:w-[360px] md:w-[400px]"
      >
        <div
          class="relative w-full flex items-center justify-end pointer-events-auto cursor-pointer"
        >
          <!-- Restore Button (Visible when minimized) -->
          <button
            (click)="toggleNextEpisodeMinimized()"
            class="absolute right-0 z-20 bg-zinc-900/90 backdrop-blur-md text-white py-2 pl-3 pr-2 rounded-l-full border-y border-l border-white/10 shadow-2xl transition-all duration-500 ease-out flex items-center gap-2 group hover:bg-zinc-800"
            [class.translate-x-full]="!nextEpisodeMinimized()"
            [class.translate-x-0]="nextEpisodeMinimized()"
            title="Show Up Next"
          >
            <!-- Mini Countdown -->
            @if (autoNextState() === 'counting_down') {
            <div class="relative w-6 h-6 flex items-center justify-center">
              <svg
                class="w-full h-full -rotate-90 transform"
                viewBox="0 0 36 36"
              >
                <path
                  class="text-white/20"
                  stroke-width="4"
                  stroke="currentColor"
                  fill="none"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path
                  class="text-white transition-all duration-1000 ease-linear"
                  stroke-dasharray="100, 100"
                  [attr.stroke-dashoffset]="(1 - autoNextCountdown() / 5) * 100"
                  stroke-width="4"
                  stroke="currentColor"
                  fill="none"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                />
              </svg>
              <span class="absolute text-[9px] font-bold">{{
                autoNextCountdown()
              }}</span>
            </div>
            }

            <span class="material-symbols-outlined text-xl">chevron_left</span>
          </button>

          <!-- Full Card -->
          <div
            class="mr-3 bg-zinc-900/95 backdrop-blur-md border border-white/10 rounded-xl p-2 sm:p-3 flex gap-2 sm:gap-3 items-center shadow-lg w-full max-w-[260px] sm:max-w-[320px] md:max-w-[340px] transition-all duration-500 ease-out transform relative z-10"
            [class.translate-x-[120%]]="nextEpisodeMinimized()"
            [class.translate-x-0]="!nextEpisodeMinimized()"
            (click)="onNextEpisodeClick()"
          >
            <!-- Thumbnail -->
            <div
              class="relative w-24 sm:w-28 md:w-32 aspect-video rounded-md overflow-hidden bg-zinc-800 shadow-lg flex-shrink-0 group cursor-pointer"
            >
              @if (nextEpisode(); as next) { @if (next.still_path) {
              <img
                [ngSrc]="'https://image.tmdb.org/t/p/w300' + next.still_path"
                width="300"
                height="169"
                class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                alt="Next Episode"
              />
              } } @else {
              <div
                class="w-full h-full flex items-center justify-center bg-zinc-800"
              >
                <span class="material-symbols-outlined text-zinc-500"
                  >movie</span
                >
              </div>
              }

              <!-- Countdown Overlay -->
              @if (autoNextState() === 'counting_down') {
              <div
                class="absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-[1px]"
              >
                <span
                  class="text-2xl sm:text-3xl font-bold text-white drop-shadow-lg animate-pulse"
                  >{{ autoNextCountdown() }}</span
                >
              </div>
              }
            </div>

            <!-- Info -->
            <div class="flex-1 min-w-0 flex flex-col justify-center gap-0.5">
              <span
                class="text-[9px] sm:text-[10px] text-zinc-400 font-bold uppercase tracking-wider"
                >Up Next</span
              >
              @if (nextEpisode(); as next) {
              <h3
                class="text-xs sm:text-sm font-bold text-white truncate leading-tight"
                [title]="next.name"
              >
                {{ next.name }}
              </h3>
              <p class="text-[11px] text-zinc-400 truncate">
                S{{ next.season_number }} â€¢ E{{ next.episode_number }}
              </p>
              } @else {
              <h3 class="text-sm font-bold text-white truncate">Next Video</h3>
              }
            </div>

            <!-- Actions -->
            <div class="flex flex-col gap-1 pl-1 border-l border-white/10">
              <button
                (click)="$event.stopPropagation(); toggleNextEpisodeMinimized()"
                class="p-1 text-zinc-400 hover:text-white hover:bg-white/10 rounded-full transition-colors"
                title="Minimize"
              >
                <span class="material-symbols-outlined text-lg"
                  >chevron_right</span
                >
              </button>
              <button
                (click)="$event.stopPropagation(); toggleAutoNext(media)"
                class="p-1 text-zinc-400 hover:text-white hover:bg-white/10 rounded-full transition-colors"
                [title]="
                  autoNextState() === 'counting_down' ||
                  !autoPlayNextTriggered()
                    ? 'Pause Autonext'
                    : 'Start Autonext'
                "
              >
                <span class="material-symbols-outlined text-lg">
                  {{
                    autoNextState() === "counting_down" ||
                    !autoPlayNextTriggered()
                      ? "autostop"
                      : "autoplay"
                  }}
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
      }
    </div>

    <!-- Video Info -->
    <div>
      <app-video-info
        [media]="media"
        [genreMap]="genreMap()"
        [currentEpisode]="currentEpisode()"
        [videoDetails]="videoDetails()"
        [currentTime]="currentPlaybackTime()"
        (episodeSelected)="onEpisodeSelected($event)"
        (refreshPlayer)="onRefreshPlayer()"
        (maximizePlayerOutput)="onMaximizePlayer()"
      >
      </app-video-info>
    </div>
  </div>

  <!-- Sidebar: Playlist or Related Videos -->
  <div class="lg:col-span-4 xl:col-span-3 mt-8 lg:mt-0">
    @if (playlist(); as pl) {
    <div class="mb-8">
      <app-video-player-playlist
        [playlist]="pl"
        [currentMediaId]="media.id"
        (selectMedia)="onSelectMedia($event)"
        (close)="onClosePlaylist()"
      />
    </div>
    }
    <app-related-videos
      [currentMedia]="media"
      [genreMap]="genreMap()"
      (selectMedia)="onSelectMedia($event)"
    >
    </app-related-videos>
  </div>
</div>
} @else {
<div class="flex justify-center items-center h-96">
  <div
    class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-red-500"
  ></div>
</div>
}
