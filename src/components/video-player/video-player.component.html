@if (selectedMediaItem(); as media) {
  <div class="p-4 sm:p-6 lg:grid lg:grid-cols-12 lg:gap-6 xl:gap-8">
    <!-- Main Content: Player and Info -->
    <div class="lg:col-span-8 xl:col-span-9">
      <!-- 
        Player Container
        Uses [ngClass] to switch between embedded (relative) and cinema mode (fixed).
        This ensures the iframe is NEVER destroyed/recreated, preventing reload.
      -->
      <div
        [ngClass]="{
          'relative mb-4 rounded-lg aspect-[16/9] overflow-hidden': !isMaximized(),
          'fixed inset-0 z-[9999] bg-black flex items-center justify-center': isMaximized()
        }"
        class="bg-black transition-all duration-300"
      >
        <!-- The actual Iframe Player -->
        <iframe
          class="w-full h-full"
          [src]="safeConstructedPlayerUrl()"
          (load)="onPlayerIframeLoad()"
          [class.invisible]="loadingTrailer() || !playerUrl() || iframeLoading()"
          title="Video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen
        >
        </iframe>
  
        <!-- Close Button (Only visible in Cinema Mode) -->
        @if (isMaximized()) {
          <div class="absolute top-2 sm:top-4 right-2 sm:right-4 z-[10000]">
            <button
              (click)="closeMaximize(); $event.stopPropagation()"
              class="flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12  rounded-full transition-colors shadow-lg backdrop-blur-sm "
              title="Exit Cinema Mode (ESC)"
            >
              <span class="material-symbols-outlined text-xl sm:text-2xl text-white">close</span>
            </button>
          </div>
        }
  
        @if (loadingTrailer() || !playerUrl() || iframeLoading()) {
        <!-- Skeleton Loading State -->
@if (loadingTrailer() || iframeLoading()) {
  <div class="w-full h-full absolute inset-0 bg-zinc-800 animate-pulse">
    <!-- Optional: Subtle play button placeholder -->
    
  </div>
} @else if (selectedPlayer() === 'YouTube' && !playerUrl()) {
  <!-- No Trailer Available Message -->
  <div class="absolute inset-0 flex items-center justify-center bg-zinc-900">
    <div class="text-center p-4">
      <span class="material-symbols-outlined mx-auto text-5xl text-zinc-600">
        videocam_off
      </span>
      <p class="text-zinc-400 mt-4">No YouTube trailer available.</p>
    </div>
  </div>
}
        }
        
        <!-- Next Episode Overlay -->
        @if (showNextEpisodeButton()) {
          <div class="absolute top-2 sm:top-4 md:top-6 lg:top-8 right-2 sm:right-4 md:right-6 lg:right-8 z-50 animate-fade-in">
            <button
              (click)="onNextEpisodeClick()"
              class="group relative overflow-hidden bg-zinc-900/90 hover:bg-zinc-800 text-white px-3 py-2 sm:px-4 sm:py-2.5 md:px-5 md:py-2.5 lg:px-6 lg:py-3 rounded-md sm:rounded-lg font-medium shadow-lg transition-all duration-300 flex items-center gap-2 sm:gap-2.5 md:gap-3 border border-zinc-700/50 backdrop-blur-sm"
            >
              <!-- Progress Bar Background (only when counting down) -->
              @if (autoNextState() === 'counting_down') {
                <div 
                  class="absolute inset-0 bg-white/10 transition-all duration-1000 ease-linear origin-left"
                  [style.width.%]="(3 - autoNextCountdown()) / 3 * 100"
                ></div>
              }
  
              <!-- Icon -->
              <span class="material-symbols-outlined text-lg sm:text-xl md:text-2xl group-hover:scale-110 transition-transform">
                skip_next
              </span>
  
              <!-- Text -->
              <div class="flex flex-col items-start z-10">
                <span class="text-[8px] sm:text-[9px] md:text-[10px] uppercase tracking-wider text-zinc-400 leading-none mb-0.5 sm:mb-1">Up Next</span>
                <span class="text-xs sm:text-sm md:text-base font-bold leading-none">
                  @if (autoNextState() === 'counting_down') {
                    Playing in {{ autoNextCountdown() }}...
                  } @else {
                    Next Episode
                  }
                </span>
              </div>
  
              <!-- Cancel Button (only when counting down) -->
              @if (autoNextState() === 'counting_down') {
                <div 
                  (click)="$event.stopPropagation(); cancelAutoNext()"
                  class="ml-1 sm:ml-2 md:ml-3 p-0.5 sm:p-1 hover:bg-white/20 rounded-full transition-colors"
                  title="Cancel Auto-Play"
                >
                  <span class="material-symbols-outlined text-sm sm:text-base md:text-lg">close</span>
                </div>
              }
            </button>
          </div>
        }
      </div>
      
      <!-- Video Info -->
      <div>
        <app-video-info
          [media]="media"
          [genreMap]="genreMap()"
          [currentEpisode]="currentEpisode()"
          [videoDetails]="videoDetails()"
          [currentTime]="currentPlaybackTime()"
          (episodeSelected)="onEpisodeSelected($event)"
          (refreshPlayer)="onRefreshPlayer()"
          (maximizePlayerOutput)="onMaximizePlayer()"
        >
        </app-video-info>
      </div>
    </div>
  
    <!-- Sidebar: Playlist or Related Videos -->
    <div class="lg:col-span-4 xl:col-span-3 mt-8 lg:mt-0">
      @if (playlist(); as pl) {
      <div class="mb-8">
        <app-video-player-playlist
          [playlist]="pl"
          [currentMediaId]="media.id"
          (selectMedia)="onSelectMedia($event)"
          (close)="onClosePlaylist()"
        />
      </div>
      }
      <app-related-videos
        [currentMedia]="media"
        [genreMap]="genreMap()"
        (selectMedia)="onSelectMedia($event)"
      >
      </app-related-videos>
    </div>
  </div>
  } @else {
  <div class="flex justify-center items-center h-96">
    <div
      class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-red-500"
    ></div>
  </div>
  }
