<div class="relative ml-2 md:ml-4">
  <button
    (click)="toggleVisible($event)"
    aria-label="Random content"
    title="Random content"
    class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center bg-zinc-800 rounded-full hover:bg-zinc-700 focus:outline-none shrink-0 transition-colors duration-150"
  >
    <span class="material-symbols-outlined text-white text-2xl">shuffle</span>
  </button>

  @if (visible()) {
  <div
    (click)="$event.stopPropagation()"
    class="absolute top-full right-0 mt-2 w-80 bg-zinc-800 rounded-lg shadow-lg z-50 border border-zinc-700 py-1 overflow-hidden"
  >
    <!-- Switches -->
    <div class="py-1">
      <!-- Random TV Show -->
      <button
        (click)="toggleRandomTvShow()"
        class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700"
      >
        <div class="flex items-center space-x-3">
          <span class="material-symbols-outlined text-xl">tv</span>
          <span>Random TV Show</span>
        </div>
        <div
          class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors"
          [class.bg-red-600]="randomTvShow()"
          [class.bg-zinc-600]="!randomTvShow()"
        >
          <span
            class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
            [class.translate-x-6]="randomTvShow()"
            [class.translate-x-1]="!randomTvShow()"
          ></span>
        </div>
      </button>

      <!-- Random Movie -->
      <button
        (click)="toggleRandomMovie()"
        class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700"
      >
        <div class="flex items-center space-x-3">
          <span class="material-symbols-outlined text-xl">movie</span>
          <span>Random Movie</span>
        </div>
        <div
          class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors"
          [class.bg-red-600]="randomMovie()"
          [class.bg-zinc-600]="!randomMovie()"
        >
          <span
            class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
            [class.translate-x-6]="randomMovie()"
            [class.translate-x-1]="!randomMovie()"
          ></span>
        </div>
      </button>

      <!-- Random Anime -->
      <button
        (click)="toggleRandomAnime()"
        class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700"
      >
        <div class="flex items-center space-x-3">
          <span class="material-symbols-outlined text-xl">animation</span>
          <span>Random Anime</span>
        </div>
        <div
          class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors"
          [class.bg-red-600]="randomAnime()"
          [class.bg-zinc-600]="!randomAnime()"
        >
          <span
            class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
            [class.translate-x-6]="randomAnime()"
            [class.translate-x-1]="!randomAnime()"
          ></span>
        </div>
      </button>
    </div>

    <!-- Slider -->
    <div class="px-3 py-3 text-sm text-left text-zinc-200 bg-zinc-800/50 border-t border-zinc-700">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs text-zinc-400">Max Age (Years)</span>
        <span class="text-xs text-zinc-200">{{ randomMaxAge() }} years</span>
      </div>
      <input
        type="range"
        min="0"
        max="100"
        step="1"
        [value]="randomMaxAge()"
        (input)="setRandomMaxAge($any($event.target).value)"
        class="w-full h-1 bg-zinc-600 rounded-lg appearance-none cursor-pointer"
        style="accent-color: #dc2626"
      />
    </div>

    <!-- Genre Filter -->
    <div class="px-3 py-2 text-sm text-left text-zinc-200 border-t border-zinc-700">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs text-zinc-400">Genres</span>
        <div class="flex gap-2 items-center">
          @if (selectedGenres().size > 0) {
          <button
            (click)="clearGenres()"
            class="text-xs text-red-500 hover:text-red-400"
          >
            Clear
          </button>
          }
          <button
            (click)="toggleGenresExpanded()"
            class="text-xs text-zinc-400 hover:text-white flex items-center"
          >
            {{ genresExpanded() ? "Less" : "More" }}
            <span class="material-symbols-outlined text-sm ml-0.5">{{ genresExpanded() ? 'expand_less' : 'expand_more' }}</span>
          </button>
        </div>
      </div>
      <div class="relative">
        <div
          class="flex flex-wrap gap-2 pr-1 transition-all duration-300 ease-in-out"
          [class.max-h-20]="!genresExpanded()"
          [class.overflow-hidden]="!genresExpanded()"
          [class.max-h-60]="genresExpanded()"
          [class.overflow-y-auto]="genresExpanded()"
        >
          @for (g of genres(); track g.id) {
          <button
            (click)="toggleGenre(g.id); $event.stopPropagation()"
            class="px-2 py-1 rounded text-xs border transition-colors"
            [class.bg-red-600]="selectedGenres().has(g.id)"
            [class.border-red-600]="selectedGenres().has(g.id)"
            [class.text-white]="selectedGenres().has(g.id)"
            [class.bg-zinc-800]="!selectedGenres().has(g.id)"
            [class.border-zinc-600]="!selectedGenres().has(g.id)"
            [class.text-zinc-300]="!selectedGenres().has(g.id)"
            [class.hover:bg-zinc-700]="!selectedGenres().has(g.id)"
          >
            {{ g.name }}
          </button>
          }
        </div>
        @if (!genresExpanded()) {
        <div
          class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-zinc-800 to-transparent pointer-events-none"
        ></div>
        }
      </div>
    </div>

    <!-- Action Button -->
    <div class="p-2 border-t border-zinc-700">
      <button
        (click)="onRandomSearch()"
        aria-label="Casino Roll"
        [disabled]="!isSelectionValid()"
        [class.opacity-50]="!isSelectionValid()"
        [class.cursor-not-allowed]="!isSelectionValid()"
        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors flex items-center justify-center gap-2"
      >
        <span class="material-symbols-outlined">shuffle</span>
        <span>Random</span>
      </button>
    </div>
  </div>
  }

  @if (showRoulette()) {
  <div class="roulette-overlay" (click)="$event.stopPropagation()">
    <div class="roulette-container">
      <div class="center-line"></div>
      <div
        class="roulette-track"
        [style.transform]="rouletteTransform()"
        [style.transition]="rouletteTransition()"
      >
        @for (item of rouletteItems(); track $index) {
        <div class="roulette-item">
          @if (item.backdrop_path) {
          <img
            [ngSrc]="'https://image.tmdb.org/t/p/w500' + item.backdrop_path"
            [alt]="item.media_type === 'movie' ? item.title : item.name"
            width="304"
            height="171"
          />
          } @else if (item.poster_path) {
          <img
            [ngSrc]="'https://image.tmdb.org/t/p/w300' + item.poster_path"
            [alt]="item.media_type === 'movie' ? item.title : item.name"
            width="304"
            height="171"
          />
          } @else {
          <div
            class="w-full aspect-video bg-zinc-800 flex items-center justify-center rounded-xl mb-3"
          >
            <span class="material-symbols-outlined text-4xl text-zinc-600"
              >movie</span
            >
          </div>
          }
          <div class="item-info opacity-50 transition-opacity duration-300" [class.opacity-100]="winnerItem() === item">
            <div class="item-title">
              {{ item.media_type === "movie" ? item.title : item.name }}
            </div>
            <div class="item-meta">
              {{ item.media_type === 'movie' ? (item.release_date | date:'yyyy') : (item.first_air_date | date:'yyyy') }} â€¢ {{ item.media_type === 'movie' ? 'Movie' : 'TV Series' }}
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    @if (winnerItem()) {
    <div class="mt-8 text-center duration-300animate-fade-in">
      <p class="text-red-600 text-xl font-bold mb-2">Winner!</p>
      <h2 class="text-3xl text-white font-bold">
        {{
          winnerItem()?.media_type === "movie"
            ? winnerItem()?.title
            : winnerItem()?.name
        }}
      </h2>
    </div>
    }
  </div>
  }
</div>
