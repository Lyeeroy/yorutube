<div class="relative ml-2 md:ml-4">
  <button
    (click)="toggleVisible($event)"
    aria-label="Random content"
    title="Random content"
    class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center bg-zinc-800 rounded-full hover:bg-zinc-700 focus:outline-none shrink-0 transition-colors duration-150"
  >
    <span class="material-symbols-outlined text-white text-2xl">shuffle</span>
  </button>

  @if (visible()) {
  <div
    (click)="$event.stopPropagation()"
    class="absolute top-full right-0 mt-2 w-80 bg-zinc-800 rounded-lg shadow-lg z-50 border border-zinc-700 py-1 overflow-hidden"
  >
    <!-- Switches -->
    <div class="py-1">
      <!-- Random TV Show -->
      <button
        (click)="toggleRandomTvShow()"
        class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700"
      >
        <div class="flex items-center space-x-3">
          <span class="material-symbols-outlined text-xl">tv</span>
          <span>Random TV Show</span>
        </div>
        <div
          class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors"
          [class.bg-red-600]="randomTvShow()"
          [class.bg-zinc-600]="!randomTvShow()"
        >
          <span
            class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
            [class.translate-x-6]="randomTvShow()"
            [class.translate-x-1]="!randomTvShow()"
          ></span>
        </div>
      </button>

      <!-- Random Movie -->
      <button
        (click)="toggleRandomMovie()"
        class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700"
      >
        <div class="flex items-center space-x-3">
          <span class="material-symbols-outlined text-xl">movie</span>
          <span>Random Movie</span>
        </div>
        <div
          class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors"
          [class.bg-red-600]="randomMovie()"
          [class.bg-zinc-600]="!randomMovie()"
        >
          <span
            class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
            [class.translate-x-6]="randomMovie()"
            [class.translate-x-1]="!randomMovie()"
          ></span>
        </div>
      </button>

      <!-- Random Anime -->
      <button
        (click)="toggleRandomAnime()"
        class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700"
      >
        <div class="flex items-center space-x-3">
          <span class="material-symbols-outlined text-xl">animation</span>
          <span>Random Anime</span>
        </div>
        <div
          class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors"
          [class.bg-red-600]="randomAnime()"
          [class.bg-zinc-600]="!randomAnime()"
        >
          <span
            class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
            [class.translate-x-6]="randomAnime()"
            [class.translate-x-1]="!randomAnime()"
          ></span>
        </div>
      </button>
    </div>

    <!-- Advanced Filters Toggle -->
    <button
      (click)="toggleFiltersExpanded()"
      class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700 border-t border-zinc-700"
    >
      <div class="flex items-center space-x-3">
        <span class="material-symbols-outlined text-xl">tune</span>
        <span>Advanced Filters</span>
      </div>
      <span class="material-symbols-outlined text-sm transition-transform duration-200" [class.rotate-180]="filtersExpanded()">expand_more</span>
    </button>

    <!-- Collapsible Filters Section -->
    <div
      class="transition-all duration-300 ease-in-out overflow-hidden bg-zinc-800/50"
      [class.max-h-0]="!filtersExpanded()"
      [class.max-h-[800px]]="filtersExpanded()"
    >
      <!-- Max Age Slider -->
      <div class="px-3 py-3 text-sm text-left text-zinc-200 border-t border-zinc-700">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-zinc-400">Max Age (Years)</span>
          <span class="text-xs text-zinc-200">{{ randomMaxAge() }} years</span>
        </div>
        <input
          type="range"
          min="0"
          max="100"
          step="1"
          [value]="randomMaxAge()"
          (input)="setRandomMaxAge($any($event.target).value)"
          class="w-full h-1 bg-zinc-600 rounded-lg appearance-none cursor-pointer"
          style="accent-color: #dc2626"
        />
      </div>

      <!-- Min Rating Slider -->
      <div class="px-3 py-3 text-sm text-left text-zinc-200 border-t border-zinc-700">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-zinc-400">Min Rating</span>
          <span class="text-xs text-zinc-200">{{ minRating() }} ★</span>
        </div>
        <input
          type="range"
          min="0"
          max="10"
          step="0.5"
          [value]="minRating()"
          (input)="setMinRating($any($event.target).value)"
          class="w-full h-1 bg-zinc-600 rounded-lg appearance-none cursor-pointer"
          style="accent-color: #dc2626"
        />
      </div>

      <!-- Genre Filter -->
      <div class="px-3 py-2 text-sm text-left text-zinc-200 border-t border-zinc-700">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-zinc-400">Genres</span>
          <div class="flex gap-2 items-center">
            @if (selectedGenres().size > 0 || excludedGenres().size > 0) {
            <button
              (click)="clearGenres()"
              class="text-xs text-red-500 hover:text-red-400"
            >
              Clear
            </button>
            }
            <button
              (click)="toggleGenresExpanded()"
              class="text-xs text-zinc-400 hover:text-white flex items-center"
            >
              {{ genresExpanded() ? "Less" : "More" }}
              <span class="material-symbols-outlined text-sm ml-0.5">{{
                genresExpanded() ? "expand_less" : "expand_more"
              }}</span>
            </button>
          </div>
        </div>
        <div class="relative">
          <div
            class="flex flex-wrap gap-2 pr-1 transition-all duration-300 ease-in-out"
            [class.max-h-20]="!genresExpanded()"
            [class.overflow-hidden]="!genresExpanded()"
            [class.max-h-60]="genresExpanded()"
            [class.overflow-y-auto]="genresExpanded()"
          >
            @for (g of genres(); track g.id) {
            <button
              (click)="toggleGenre(g.id); $event.stopPropagation()"
              class="px-2 py-1 rounded text-xs border transition-colors"
              [class.bg-red-600]="selectedGenres().has(g.id)"
              [class.border-red-600]="selectedGenres().has(g.id)"
              [class.text-white]="selectedGenres().has(g.id)"
              [class.bg-zinc-950]="excludedGenres().has(g.id)"
              [class.border-zinc-800]="excludedGenres().has(g.id)"
              [class.text-zinc-500]="excludedGenres().has(g.id)"
              [class.line-through]="excludedGenres().has(g.id)"
              [class.bg-zinc-800]="
                !selectedGenres().has(g.id) && !excludedGenres().has(g.id)
              "
              [class.border-zinc-600]="
                !selectedGenres().has(g.id) && !excludedGenres().has(g.id)
              "
              [class.text-zinc-300]="
                !selectedGenres().has(g.id) && !excludedGenres().has(g.id)
              "
              [class.hover:bg-zinc-700]="
                !selectedGenres().has(g.id) && !excludedGenres().has(g.id)
              "
            >
              {{ g.name }}
            </button>
            }
          </div>
          @if (!genresExpanded()) {
          <div
            class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-zinc-800 to-transparent pointer-events-none"
          ></div>
          }
        </div>
      </div>

      <!-- Language Filter -->
      <div class="px-3 py-2 text-sm text-left text-zinc-200 border-t border-zinc-700">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-zinc-400">Languages</span>
          <div class="flex gap-2 items-center">
            @if (selectedLanguages().size > 0 || excludedLanguages().size > 0) {
            <button
              (click)="clearLanguages()"
              class="text-xs text-red-500 hover:text-red-400"
            >
              Clear
            </button>
            }
            <button
              (click)="toggleLanguagesExpanded()"
              class="text-xs text-zinc-400 hover:text-white flex items-center"
            >
              {{ languagesExpanded() ? "Less" : "More" }}
              <span class="material-symbols-outlined text-sm ml-0.5">{{
                languagesExpanded() ? "expand_less" : "expand_more"
              }}</span>
            </button>
          </div>
        </div>
        <div class="relative">
          <div
            class="flex flex-wrap gap-2 pr-1 transition-all duration-300 ease-in-out"
            [class.max-h-20]="!languagesExpanded()"
            [class.overflow-hidden]="!languagesExpanded()"
            [class.max-h-60]="languagesExpanded()"
            [class.overflow-y-auto]="languagesExpanded()"
          >
            @for (l of languages(); track l.code) {
            <button
              (click)="toggleLanguage(l.code); $event.stopPropagation()"
              class="px-2 py-1 rounded text-xs border transition-colors"
              [class.bg-red-600]="selectedLanguages().has(l.code)"
              [class.border-red-600]="selectedLanguages().has(l.code)"
              [class.text-white]="selectedLanguages().has(l.code)"
              [class.bg-zinc-950]="excludedLanguages().has(l.code)"
              [class.border-zinc-800]="excludedLanguages().has(l.code)"
              [class.text-zinc-500]="excludedLanguages().has(l.code)"
              [class.line-through]="excludedLanguages().has(l.code)"
              [class.bg-zinc-800]="
                !selectedLanguages().has(l.code) && !excludedLanguages().has(l.code)
              "
              [class.border-zinc-600]="
                !selectedLanguages().has(l.code) && !excludedLanguages().has(l.code)
              "
              [class.text-zinc-300]="
                !selectedLanguages().has(l.code) && !excludedLanguages().has(l.code)
              "
              [class.hover:bg-zinc-700]="
                !selectedLanguages().has(l.code) && !excludedLanguages().has(l.code)
              "
            >
              {{ l.name }}
            </button>
            }
          </div>
          @if (!languagesExpanded()) {
          <div
            class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-zinc-800 to-transparent pointer-events-none"
          ></div>
          }
        </div>
      </div>
    </div>

    <!-- Action Button -->
    <div class="p-2 border-t border-zinc-700">
      <button
        (click)="onRandomSearch()"
        aria-label="Casino Roll"
        [disabled]="!isSelectionValid()"
        [class.opacity-50]="!isSelectionValid()"
        [class.cursor-not-allowed]="!isSelectionValid()"
        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors flex items-center justify-center gap-2"
      >
        <span class="material-symbols-outlined">shuffle</span>
        <span>Random</span>
      </button>
    </div>
  </div>
  } @if (showRoulette()) {
  <div class="roulette-overlay" (click)="$event.stopPropagation()">
    <div class="roulette-wrapper">
      <div class="center-line"></div>
      <div
        class="roulette-container"
        #rouletteContainer
        [class.overflow-x-auto]="isInteractive()"
        [class.overflow-hidden]="!isInteractive()"
        [class.cursor-grab]="isInteractive()"
        [class.cursor-grabbing]="isGrabbing()"
        [class.select-none]="isGrabbing()"
        style="scrollbar-width: none; -ms-overflow-style: none"
        (mousedown)="onMouseDown($event)"
        (mouseleave)="onMouseLeave()"
        (mouseup)="onMouseUp()"
        (mousemove)="onMouseMove($event)"
        (dragstart)="$event.preventDefault()"
      >
        <div
          class="roulette-track"
          [style.transform]="isInteractive() ? 'none' : rouletteTransform()"
          [style.transition]="isInteractive() ? 'none' : rouletteTransition()"
        >
          @for (item of rouletteItems(); track $index) {
          <div class="roulette-item" (click)="onItemClick(item)">
            @if (item.backdrop_path) {
            <img
              [ngSrc]="'https://image.tmdb.org/t/p/w500' + item.backdrop_path"
              [alt]="item.media_type === 'movie' ? item.title : item.name"
              width="304"
              height="171"
            />
            } @else if (item.poster_path) {
            <img
              [ngSrc]="'https://image.tmdb.org/t/p/w300' + item.poster_path"
              [alt]="item.media_type === 'movie' ? item.title : item.name"
              width="304"
              height="171"
            />
            } @else {
            <div
              class="w-full aspect-video bg-zinc-800 flex items-center justify-center rounded-xl mb-3"
            >
              <span class="material-symbols-outlined text-4xl text-zinc-600"
                >movie</span
              >
            </div>
            }
            <div
              class="item-info opacity-50 transition-opacity duration-300"
              [class.opacity-100]="selectedItem() === item"
            >
              <div class="item-title">
                {{ item.media_type === "movie" ? item.title : item.name }}
              </div>
              <div class="item-meta">
                {{
                  item.media_type === "movie"
                    ? (item.release_date | date : "yyyy")
                    : (item.first_air_date | date : "yyyy")
                }}
                • {{ item.media_type === "movie" ? "Movie" : "TV Series" }}
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    @if (selectedItem(); as selected) {
    <div
      class="mt-8 text-center flex flex-col items-center z-50 relative w-full max-w-4xl px-4 winner-reveal-container"
      [class.open]="isWinnerRevealed()"
    >
      <div class="winner-reveal-inner flex flex-col items-center w-full">
        <!-- Winner Badge (Only if it's the actual winner) -->
        @if (selected === winnerItem()) {
        <div class="mb-4 animate-fade-in-up">
          <span
            class="px-3 py-1 bg-yellow-500/20 text-yellow-500 border border-yellow-500/50 rounded-full text-xs font-bold uppercase tracking-wider shadow-[0_0_15px_rgba(234,179,8,0.3)]"
          >
            Winner
          </span>
        </div>
        }

        <!-- Title -->
        <h2
          class="text-4xl md:text-5xl text-white font-bold mb-4 animate-fade-in-up text-center leading-tight drop-shadow-lg"
          style="animation-delay: 0.1s"
        >
          {{ mediaTitle() }}
        </h2>

        <!-- Metadata Row -->
        <div
          class="flex flex-wrap items-center justify-center gap-3 text-sm md:text-base text-zinc-300 mb-6 animate-fade-in-up"
          style="animation-delay: 0.15s"
        >
          <span class="font-medium text-white">
            {{
              isMovie()
                ? (selected.release_date | date : "yyyy")
                : (selected.first_air_date | date : "yyyy")
            }}
          </span>
          <span class="w-1 h-1 bg-zinc-500 rounded-full"></span>
          <span class="capitalize">{{
            isMovie() ? "Movie" : "TV Series"
          }}</span>

          @if (selected.vote_average) {
          <span class="w-1 h-1 bg-zinc-500 rounded-full"></span>
          <div class="flex items-center gap-1 text-green-400">
            <span class="material-symbols-outlined text-sm">star</span>
            <span>{{ selected.vote_average | number : "1.1-1" }}</span>
          </div>
          }

          <!-- Channel Info -->
          @if (subscribableChannel(); as channel) {
          <span class="w-1 h-1 bg-zinc-500 rounded-full"></span>
          <div class="flex items-center gap-2">
            @if (channel.logo_path) {
            <img
              [ngSrc]="'https://image.tmdb.org/t/p/w92' + channel.logo_path"
              [alt]="channel.name"
              width="20"
              height="20"
              class="object-contain h-5 w-auto rounded px-1"
            />
            }
            <span>{{ channel.name }}</span>
          </div>
          }
        </div>

        <!-- Overview -->
        <p
          class="text-zinc-300 text-base md:text-lg max-w-2xl mb-8 leading-relaxed drop-shadow-md animate-fade-in-up line-clamp-3 text-center"
          style="animation-delay: 0.2s"
        >
          {{ selected.overview }}
        </p>

        <!-- Actions / Timer -->
        @if (!isAutoNavCancelled() && selected === winnerItem()) {
        <div
          class="flex flex-col items-center gap-4 animate-fade-in-up"
          style="animation-delay: 0.3s"
        >
          <div
            class="relative w-16 h-16 flex items-center justify-center group cursor-pointer"
            (click)="cancelAutoNav()"
          >
            <!-- Progress Ring -->
            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
              <circle
                class="text-zinc-800"
                stroke-width="6"
                stroke="currentColor"
                fill="transparent"
                r="44"
                cx="50"
                cy="50"
              />
              <circle
                class="text-red-600 progress-ring__circle"
                stroke-width="6"
                stroke-linecap="round"
                stroke="currentColor"
                fill="transparent"
                r="44"
                cx="50"
                cy="50"
                stroke-dasharray="276.46"
                [attr.stroke-dashoffset]="isWinnerRevealed() ? '0' : '276.46'"
              />
            </svg>
            <!-- Play Icon (Default) / Cancel Icon (Hover) -->
            <div
              class="relative z-10 w-12 h-12 bg-white rounded-full flex items-center justify-center transition-transform group-hover:scale-90 shadow-lg"
            >
              <span
                class="material-symbols-outlined text-black text-2xl"
                >pause</span
              >
            </div>
          </div>
          <div class="flex flex-col items-center">
            <span class="text-zinc-400 text-sm font-medium"
              >Playing in 5s...</span
            >
            <button
              (click)="cancelAutoNav()"
              class="text-xs text-zinc-500 hover:text-zinc-300 mt-1"
            >
              Cancel Auto-play
            </button>
          </div>
        </div>
        } @else {
        <div
          class="flex flex-wrap justify-center gap-4 mb-8 animate-fade-in-up"
        >
          <button
            (click)="watchNow(selected)"
            class="px-8 py-3 bg-white hover:bg-zinc-200 text-black rounded-full font-bold transition-colors flex items-center gap-2 shadow-lg shadow-white/10"
          >
            <span class="material-symbols-outlined">play_arrow</span>
            Watch Now
          </button>

          <!-- Watchlist Button -->
          <button
            (click)="toggleWatchlist($event)"
            class="px-4 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-full font-medium transition-colors flex items-center gap-2 border border-zinc-700"
            [title]="
              isOnWatchlist() ? 'Remove from Watchlist' : 'Add to Watchlist'
            "
          >
            <span
              class="material-symbols-outlined"
              [class.material-symbols-filled]="isOnWatchlist()"
            >
              watch_later
            </span>
            <span>{{ isOnWatchlist() ? "In Watchlist" : "Watchlist" }}</span>
          </button>

          <!-- Playlist Button -->
          <button
            (click)="openPlaylistModal($event)"
            class="px-4 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-full font-medium transition-colors flex items-center gap-2 border border-zinc-700"
            [title]="isInPlaylist() ? 'Saved to playlist' : 'Save to playlist'"
          >
            <span class="material-symbols-outlined">
              {{ isInPlaylist() ? "playlist_add_check" : "playlist_add" }}
            </span>
            <span>{{ isInPlaylist() ? "Saved" : "Save" }}</span>
          </button>

          <button
            (click)="reroll()"
            class="px-6 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-full font-medium transition-colors flex items-center gap-2 border border-zinc-700"
          >
            <span class="material-symbols-outlined">refresh</span>
            Reroll
          </button>
          <button
            (click)="closeRoulette()"
            class="px-6 py-3 bg-transparent hover:bg-zinc-800 text-zinc-300 rounded-full font-medium transition-colors border border-zinc-700"
          >
            Close
          </button>
        </div>
        }
      </div>
    </div>
    }
  </div>
  }
</div>

@if (showPlaylistModal()) { @if (selectedItem(); as media) {
<app-add-to-playlist-modal
  [media]="media"
  (close)="showPlaylistModal.set(false)"
/>
} }
