<div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6 cursor-pointer group" (click)="mediaClicked.emit()">
  <div class="sm:w-2/5 md:w-1/3 lg:w-1/4 xl:w-1/5 shrink-0">
    <div class="relative rounded-lg overflow-hidden aspect-video">
      @if (isPriority()) {
        <img 
          [ngSrc]="thumbnailUrl()"
          [alt]="mediaTitle()"
          width="480"
          height="270"
          priority
          class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300 ease-in-out"
        />
      } @else {
        <img 
          [ngSrc]="thumbnailUrl()"
          [alt]="mediaTitle()"
          width="480"
          height="270"
          class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300 ease-in-out"
        />
      }
      <div class="absolute inset-0 bg-black bg-opacity-10"></div>
      @if (progress() > 0) {
        <div class="absolute bottom-0 left-0 w-full h-1 bg-zinc-700/80">
          <div class="h-full bg-red-600" [style.width.%]="progress()"></div>
        </div>
      }
      @if (media().media_type === 'movie') {
        <span class="absolute bottom-2 right-2 bg-black/60 backdrop-blur-sm text-white text-xs font-semibold px-2 py-1 rounded-md">MOVIE</span>
      } @else {
        <span class="absolute bottom-2 right-2 bg-black/60 backdrop-blur-sm text-white text-xs font-semibold px-2 py-1 rounded-md">TV SHOW</span>
      }
      <div class="absolute top-2 right-2 flex flex-col space-y-2 z-10">
        <button 
          (click)="toggleWatchlist($event)"
          class="bg-black/60 backdrop-blur-sm p-1.5 rounded-md text-white hover:bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity"
          [title]="isOnWatchlist() ? 'Remove from Watchlist' : 'Add to Watchlist'">
          @if(isOnWatchlist()) {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
            </svg>
          } @else {
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          }
        </button>
        <button 
          (click)="openPlaylistModal($event)"
          class="bg-black/60 backdrop-blur-sm p-1.5 rounded-md text-white hover:bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity"
          [title]="isInPlaylist() ? 'Saved to playlist' : 'Save to playlist'">
          @if (isInPlaylist()) {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zm11.707 1.293a1 1 0 010 1.414l-2 2a1 1 0 01-1.414 0l-1-1a1 1 0 111.414-1.414L12 14.586l1.293-1.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          }
        </button>
      </div>
    </div>
  </div>
  <div class="sm:w-3/5 md:w-2/3 lg:w-3/4 xl:w-4/5">
    <div class="flex items-start justify-between relative">
      <h3 class="text-white font-semibold text-lg leading-snug group-hover:text-red-500 transition-colors line-clamp-2 pr-2" [title]="mediaTitle()">
        {{ mediaTitle() }}
      </h3>
       <button (click)="toggleOptionsMenu($event)" class="text-zinc-400 hover:text-white p-1 -mr-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" title="More options">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
      </button>
      @if (showOptionsMenu()) {
        <div class="absolute top-full right-0 mt-1 w-56 bg-zinc-800 rounded-md shadow-lg z-20 border border-zinc-700 py-1">
            <button (click)="toggleWatchlist($event)" class="w-full flex items-center space-x-3 px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700">
              @if(isOnWatchlist()) {
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Remove from Watchlist</span>
              } @else {
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Save to Watchlist</span>
              }
            </button>
            <button (click)="openPlaylistModal($event)" class="w-full flex items-center space-x-3 px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700">
                @if (isInPlaylist()) {
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zm11.707 1.293a1 1 0 010 1.414l-2 2a1 1 0 01-1.414 0l-1-1a1 1 0 111.414-1.414L12 14.586l1.293-1.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                  <span>Saved to playlist</span>
                } @else {
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                  <span>Save to playlist</span>
                }
            </button>
            <div class="border-t border-zinc-700/50 my-1 mx-2"></div>
            <button (click)="openDetailsModal($event)" class="w-full flex items-center space-x-3 px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Details</span>
            </button>
        </div>
      }
    </div>
    <div class="text-gray-400 text-sm mt-2 flex items-center space-x-2">
      <span>{{ media().vote_average.toFixed(1) }} Rating</span>
      <span>&bull;</span>
      <span>{{ relativeTime() }}</span>
      @if (primaryGenre()) {
        <span>&bull;</span>
        <span>{{ primaryGenre() }}</span>
      }
    </div>

    @if (channelName(); as name) {
      <div (click)="onChannelClick($event)" class="flex items-center space-x-2 mt-3" [class.cursor-pointer]="subscribableChannel()">
        <div 
            class="h-6 w-6 rounded-full flex items-center justify-center shrink-0 hover:opacity-80 transition-opacity relative"
            [class.bg-white]="channelLogoUrl()" 
            [class.bg-zinc-700]="!channelLogoUrl()">
            @if (channelLogoUrl(); as logoUrl) {
              <img [ngSrc]="logoUrl" [alt]="name" fill class="p-1 object-contain">
            } @else {
              <span class="text-xs font-bold text-white">{{ name.charAt(0) }}</span>
            }
        </div>
        <p class="text-gray-400 text-sm truncate hover:text-white transition-colors" [title]="name">{{ name }}</p>
      </div>
    }

    @if (media().overview) {
      <p class="text-gray-400 text-sm mt-3 line-clamp-2 md:line-clamp-3">
        {{ media().overview }}
      </p>
    }
  </div>
</div>
@if (showPlaylistModal()) {
  <app-add-to-playlist-modal 
    [media]="media()"
    (close)="showPlaylistModal.set(false)"
  />
}
@if (showDetailsModal()) {
  <app-media-detail-modal
    [media]="media()"
    (close)="showDetailsModal.set(false)"
  />
}
