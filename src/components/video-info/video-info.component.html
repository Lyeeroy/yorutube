<div class="text-white">
  <h1 class="text-xl md:text-2xl font-bold">{{ mediaTitle() }}</h1>

  <div class="flex flex-col md:flex-row md:items-center justify-between mt-3 gap-4">
    <!-- Channel Info & Subscribe Button -->
    <div class="flex items-center justify-between">
      @if (channelInfo(); as channel) {
        <div (click)="onChannelClick()" class="flex items-center space-x-3 min-w-0" [class.cursor-pointer]="subscribableChannel()">
          @if (channel.logoUrl) {
            <div class="h-10 w-10 rounded-full bg-white flex items-center justify-center shrink-0 hover:opacity-80 transition-opacity relative">
              <img [ngSrc]="channel.logoUrl" [alt]="channel.name + ' Logo'" fill class="p-1.5 object-contain">
            </div>
          } @else {
             <div class="h-10 w-10 rounded-full bg-zinc-700 flex items-center justify-center shrink-0 hover:opacity-80 transition-opacity">
              <svg class="w-5 h-5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
              </svg>
            </div>
          }
          <div class="min-w-0">
            <p class="text-white font-semibold truncate hover:text-red-500 transition-colors">{{ channel.name }}</p>
          </div>
        </div>
      } @else {
        <!-- Skeleton loader for channel info -->
        <div class="flex items-center space-x-3 animate-pulse min-w-0">
          <div class="h-10 w-10 rounded-full bg-zinc-700"></div>
          <div class="flex-1 space-y-2">
            <div class="h-4 bg-zinc-700 rounded w-48"></div>
            <div class="h-3 bg-zinc-700 rounded w-32"></div>
          </div>
        </div>
      }

      @if (subscribableChannel()) {
        <button 
          (click)="toggleSubscription()"
          class="ml-4 text-sm font-bold py-2 px-5 rounded-full transition-colors shrink-0"
          [class.bg-white]="!isSubscribed()"
          [class.text-black]="!isSubscribed()"
          [class.hover:bg-zinc-200]="!isSubscribed()"
          [class.bg-zinc-600]="isSubscribed()"
          [class.hover:bg-zinc-500]="isSubscribed()"
          [class.text-white]="isSubscribed()">
          {{ isSubscribed() ? 'Subscribed' : 'Subscribe' }}
        </button>
      }
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center space-x-2 flex-wrap gap-y-2">
      <!-- Sources Dropdown -->
      <div class="relative">
        <button (click)="toggleSourcesDropdown($event)" class="h-10 w-10 sm:w-auto sm:px-4 flex items-center justify-center space-x-2 bg-zinc-800 hover:bg-zinc-700 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 0 1 0 .656l-5.603 3.113a.375.375 0 0 1-.557-.328V8.887c0-.286.358-.473.557-.327l5.603 3.112Z" />
          </svg>
          <span class="hidden sm:inline">Sources</span>
           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform" [class.rotate-180]="showSourcesDropdown()" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        @if (showSourcesDropdown()) {
          <div (click)="$event.stopPropagation()" class="absolute top-full left-0 md:right-0 md:left-auto mt-2 w-48 bg-zinc-800 rounded-lg shadow-lg z-20 border border-zinc-700 py-1">
            <button (click)="selectPlayer('VIDEASY')" class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700">
              <span>VIDEASY</span>
              @if (selectedPlayer() === 'VIDEASY') {
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
              }
            </button>
          </div>
        }
      </div>

      <button (click)="toggleWatchlist()" class="h-10 w-10 sm:w-auto sm:px-4 flex items-center justify-center space-x-2 bg-zinc-800 hover:bg-zinc-700 rounded-full">
       @if (isOnWatchlist()) {
         <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
           <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
         </svg>
         <span class="hidden sm:inline">Added</span>
       } @else {
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
         <span class="hidden sm:inline">Watchlist</span>
       }
     </button>
     <button (click)="showPlaylistModal.set(true)" class="h-10 w-10 sm:w-auto sm:px-4 flex items-center justify-center space-x-2 bg-zinc-800 hover:bg-zinc-700 rounded-full">
       @if (isInPlaylist()) {
         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
           <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zm11.707 1.293a1 1 0 010 1.414l-2 2a1 1 0 01-1.414 0l-1-1a1 1 0 111.414-1.414L12 14.586l1.293-1.293a1 1 0 011.414 0z" clip-rule="evenodd" />
         </svg>
         <span class="hidden sm:inline">Saved</span>
       } @else {
         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
           <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
         </svg>
         <span class="hidden sm:inline">Save</span>
       }
     </button>
     
     <!-- More Options Menu -->
     <div class="relative">
       <button (click)="toggleMoreOptionsMenu($event)" class="flex items-center justify-center w-10 h-10 bg-zinc-800 hover:bg-zinc-700 rounded-full">
         <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
       </button>

       @if (showMoreOptionsMenu()) {
         <div (click)="$event.stopPropagation()" class="absolute top-full left-0 md:right-0 md:left-auto mt-2 w-56 bg-zinc-800 rounded-lg shadow-lg z-20 border border-zinc-700 py-1">
           @if (videoDetails()) {
             <button (click)="onWatchTrailerClick()" class="w-full flex items-center space-x-3 px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M6.32 1.805a1 1 0 011.36.012l8.5 7.5a1 1 0 010 1.366l-8.5 7.5a1 1 0 01-1.36.012A1.002 1.002 0 016 17.5V2.5a1 1 0 01.32-.795z" />
                </svg>
               <span>Watch Trailer</span>
             </button>
           }
           <button (click)="toggleAutoNext()" class="w-full flex items-center justify-between px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700">
            <div class="flex items-center space-x-3">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                 <path stroke-linecap="round" stroke-linejoin="round" d="m12.75 15 3-3m0 0-3-3m3 3h-7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
               </svg>
               <span>Auto Next</span>
            </div>
            <!-- Toggle Switch UI -->
            <div class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors" [class.bg-red-600]="autoNextEnabled()" [class.bg-zinc-600]="!autoNextEnabled()">
               <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform" [class.translate-x-6]="autoNextEnabled()" [class.translate-x-1]="!autoNextEnabled()"></span>
            </div>
          </button>
          <button (click)="onRefreshPlayerClick()" class="w-full flex items-center space-x-3 px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.293 1.293a1 1 0 000 1.415L18.586 4H7a5 5 0 00-5 5v4a1 1 0 102 0V9a3 3 0 013-3h11.586l-1.293 1.293a1 1 0 001.414 1.415L22.414 5l-3.707-3.707a1 1 0 00-1.414 0ZM21 10a1 1 0 00-1 1v4a3 3 0 01-3 3H5.414l1.293-1.292a1.001 1.001 0 00-1.414-1.415L1.586 19l3.707 3.707a1 1 0 101.414-1.413L5.414 20H17a5 5 0 005-5v-4a1 1 0 00-1-1Z"></path>
            </svg>
            <span>Refresh Player</span>
          </button>
           <button class="w-full flex items-center space-x-3 px-3 py-2 text-sm text-left text-zinc-200 hover:bg-zinc-700">
             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path></svg>
             <span>Share</span>
           </button>
         </div>
       }
     </div>
   </div>
  </div>

  <!-- Description Box -->
  <div 
    (click)="toggleDescription()"
    class="bg-zinc-800 rounded-xl mt-4 text-sm text-zinc-300 cursor-pointer hover:bg-zinc-700/50 transition-colors">
    <div class="p-4">
      <!-- Header: Always visible -->
      <p class="font-semibold text-white">{{ releaseDateInfo() }}</p>

      @if (descriptionExpanded()) {
        <!-- Expanded Content -->
        <div class="mt-3">
          @if (overview()) {
            <p class="leading-relaxed whitespace-pre-wrap">
              {{ overview() }}
            </p>
          }
          <div class="mt-4 pt-4 border-t border-zinc-700 space-y-3">
            @if (runtimeInfo()) {
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-2">
                <span class="font-semibold text-zinc-400">Duration</span>
                <span class="sm:col-span-2">{{ runtimeInfo() }}</span>
              </div>
            }
             @if (genres().length > 0) {
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-2">
                <span class="font-semibold text-zinc-400">Genre</span>
                <span class="sm:col-span-2">{{ genresString() }}</span>
              </div>
            }
            @if (castString()) {
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-2">
                <span class="font-semibold text-zinc-400">Starring</span>
                <span class="sm:col-span-2">{{ castString() }}</span>
              </div>
            }
            @if (director()) {
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-2">
                <span class="font-semibold text-zinc-400">Director</span>
                <span class="sm:col-span-2">{{ director() }}</span>
              </div>
            }
             @if (creatorsString()) {
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-2">
                <span class="font-semibold text-zinc-400">Creators</span>
                <span class="sm:col-span-2">{{ creatorsString() }}</span>
              </div>
            }
            @if(movieDetails()?.belongs_to_collection; as collection) {
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-2">
                  <span class="font-semibold text-zinc-400">Part of</span>
                  <button (click)="$event.stopPropagation(); goToCollection(collection)" class="text-red-500 hover:underline text-left sm:col-span-2">{{ collection.name }}</button>
              </div>
            }
          </div>
          <span class="font-semibold mt-4 text-white inline-block">Show less</span>
        </div>
      } @else {
        <!-- Collapsed Content -->
        <div class="mt-1">
          @if (overview()) {
            <p class="leading-relaxed whitespace-pre-wrap line-clamp-2 text-zinc-400">
              {{ overview() }}
            </p>
          }
          <span class="font-semibold mt-2 text-white inline-block">...more</span>
        </div>
      }
    </div>
  </div>

  <!-- Seasons & Episodes Section -->
  @if (tvShowDetails(); as tv) {
    <div class="mt-6">
      <h2 class="text-xl font-bold mb-3">Seasons & Episodes</h2>
      <div class="bg-zinc-800 rounded-xl p-4">
        <!-- Season Selector -->
        <div class="flex items-center space-x-2 border-b border-zinc-700 pb-3 mb-3 overflow-x-auto">
          @for (season of tv.seasons; track season.id) {
            <button 
              (click)="selectSeason(season)"
              class="px-4 py-2 rounded-full text-sm font-semibold transition-colors shrink-0"
              [class.bg-white]="selectedSeasonDetails()?.season_number === season.season_number"
              [class.text-black]="selectedSeasonDetails()?.season_number === season.season_number"
              [class.bg-zinc-700]="selectedSeasonDetails()?.season_number !== season.season_number"
              [class.text-white]="selectedSeasonDetails()?.season_number !== season.season_number"
              [class.hover:bg-zinc-600]="selectedSeasonDetails()?.season_number !== season.season_number">
              {{ season.name }}
            </button>
          }
        </div>
        
        <!-- Episode List -->
        @if (loadingSeason()) {
            <div class="flex justify-center items-center h-48">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-500"></div>
            </div>
        } @else if (selectedSeasonDetails(); as season) {
          <div class="flex flex-col space-y-2 max-h-96 overflow-y-auto pr-2">
            @for (episode of season.episodes; track episode.id) {
              <div 
                class="flex items-start p-2 rounded-lg hover:bg-zinc-700 cursor-pointer transition-colors"
                [class.bg-zinc-700]="currentEpisode()?.id === episode.id"
                (click)="selectEpisode(episode, season.season_number)">
                <span class="text-zinc-400 w-8 text-center pt-1 shrink-0">{{ episode.episode_number }}</span>
                <div class="relative w-24 sm:w-32 shrink-0 rounded-md overflow-hidden">
                  <img [ngSrc]="episode.still_path ? 'https://image.tmdb.org/t/p/w300' + episode.still_path : 'https://picsum.photos/seed/' + episode.id + '/300/169?grayscale'" alt="Episode {{ episode.episode_number }} thumbnail" width="300" height="169" class="w-full object-cover">
                  @if(getProgress(episode.id) > 0) {
                    <div class="absolute bottom-0 left-0 w-full h-1 bg-zinc-700/80">
                      <div class="h-full bg-red-600" [style.width.%]="getProgress(episode.id)"></div>
                    </div>
                  }
                </div>
                <div class="flex-1 min-w-0 pl-3">
                  <div class="flex justify-between items-start">
                    <h4 class="font-semibold text-sm text-white line-clamp-1">{{ episode.name }}</h4>
                    <span class="text-xs text-zinc-400 shrink-0">{{ getRelativeTime(episode.air_date) }}</span>
                  </div>
                  <p class="text-xs text-zinc-400 mt-1" [class.line-clamp-2]="expandedEpisodeId() !== episode.id" (click)="$event.stopPropagation(); toggleEpisodeDescription(episode.id)">{{ episode.overview }}</p>
                </div>
              </div>
            } @empty {
              <p class="text-zinc-500 text-center py-8">No episode information available for this season.</p>
            }
          </div>
        } @else {
          <div class="flex justify-center items-center h-48">
            <p class="text-zinc-500">Select a season to view episodes.</p>
          </div>
        }
      </div>
    </div>
  }
  
  @if (showPlaylistModal()) {
    <app-add-to-playlist-modal 
      [media]="media()"
      (close)="showPlaylistModal.set(false)"
    />
  }
</div>