<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center" (click)="close.emit()">
  <div 
    (click)="$event.stopPropagation()"
    class="bg-zinc-900 rounded-lg shadow-2xl w-full max-w-4xl h-[90vh] max-h-[800px] border border-zinc-800 flex flex-col relative overflow-hidden">
    
    <button (click)="close.emit()" class="absolute top-3 right-3 text-white bg-black/50 rounded-full p-2 z-20 hover:bg-black/80">
      <span class="material-symbols-outlined">close</span>
    </button>
      
    @if(loading()) {
      <div class="flex-grow flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-red-500"></div>
      </div>
    } @else if (details(); as d) {
      <div class="flex-grow overflow-y-auto">
        <!-- Backdrop Header -->
        <div class="relative h-64 md:h-80 w-full">
          @if(backdropUrl(); as url) {
            <img [ngSrc]="url" [alt]="d.media_type === 'movie' ? d.title : d.name" fill class="object-cover object-top" priority>
          }
          <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-900/80 to-transparent"></div>
        </div>

        <!-- Main Content -->
        <div class="p-6 md:p-8 -mt-24 relative z-10">
          <div class="flex flex-col md:flex-row gap-8">
            <div class="w-40 md:w-48 shrink-0 mx-auto md:mx-0">
              <img [ngSrc]="posterUrl()" [alt]="d.media_type === 'movie' ? d.title : d.name" width="500" height="750" class="rounded-lg shadow-2xl">
            </div>
            <div class="flex-grow pt-4 text-center md:text-left">
              <h1 class="text-3xl md:text-4xl font-bold text-white">{{ d.media_type === 'movie' ? d.title : d.name }}</h1>
              <div class="text-zinc-400 text-sm flex items-center justify-center md:justify-start space-x-2 mt-2">
                <span>{{ getYear(d.media_type === 'movie' ? d.release_date : d.first_air_date) }}</span>
                <span>â€¢</span>
                <span>{{ d.vote_average.toFixed(1) }} Rating</span>
              </div>
              @if(movieDetails()?.belongs_to_collection; as collection) {
                <div class="mt-2 text-sm flex items-center justify-center md:justify-start space-x-2">
                  <span class="text-zinc-400">Part of</span>
                  <button (click)="goToCollection(collection)" class="text-red-500 hover:underline font-semibold">
                    {{ collection.name }}
                  </button>
                </div>
              }
              <div class="mt-4 flex flex-wrap gap-2 justify-center md:justify-start">
                 <button (click)="playMedia()" class="h-10 px-6 flex items-center justify-center space-x-2 bg-white hover:bg-zinc-200 rounded-full text-black text-sm font-bold">
                    <span class="material-symbols-outlined text-3xl -ml-1">play_arrow</span>
                    <span>Play</span>
                 </button>
                 <button 
                    (click)="toggleWatchlist($event)"
                    class="h-10 px-4 flex items-center justify-center space-x-2 bg-zinc-800 hover:bg-zinc-700 rounded-full text-white text-sm font-semibold">
                   @if (isOnWatchlist()) {
                     <span class="material-symbols-outlined text-xl">check</span>
                     <span>Added to Watchlist</span>
                   } @else {
                     <span class="material-symbols-outlined text-xl">add</span>
                     <span>Add to Watchlist</span>
                   }
                 </button>
                 <button (click)="showPlaylistModal.set(true)" class="h-10 px-4 flex items-center justify-center space-x-2 bg-zinc-800 hover:bg-zinc-700 rounded-full text-white text-sm font-semibold">
                    <span class="material-symbols-outlined text-xl">playlist_add</span>
                    <span>Save</span>
                 </button>
              </div>
            </div>
          </div>

          <!-- Synopsis & Trailer -->
          <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
              <h2 class="text-xl font-bold mb-2">Synopsis</h2>
              <p class="text-zinc-300 text-sm leading-relaxed">{{ d.overview }}</p>
            </div>
            @if(trailerUrl(); as url) {
              <div>
                <h2 class="text-xl font-bold mb-2">Trailer</h2>
                <div class="aspect-video rounded-lg overflow-hidden">
                  <iframe [src]="url" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
              </div>
            }
          </div>

          <!-- Cast -->
          @if(d.credits?.cast?.length) {
            <div class="mt-8">
              <h2 class="text-xl font-bold mb-4">Cast</h2>
              <div class="flex overflow-x-auto space-x-4 pb-4 -mb-4">
                @for(member of d.credits.cast.slice(0, 15); track member.id) {
                  <div class="w-28 text-center shrink-0">
                    <img 
                      [ngSrc]="member.profile_path ? 'https://image.tmdb.org/t/p/w300' + member.profile_path : 'https://picsum.photos/seed/' + member.id + '/300/450'" 
                      [alt]="member.name"
                      width="300" height="450"
                      class="w-24 h-24 rounded-full object-cover mx-auto"
                    >
                    <p class="text-white text-sm font-semibold mt-2 truncate">{{ member.name }}</p>
                    <p class="text-zinc-400 text-xs truncate">{{ member.character }}</p>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    } @else {
      <div class="p-8 text-center text-zinc-400">
        Could not load details for this item.
      </div>
    }
  </div>
</div>

@if (showPlaylistModal()) {
    <app-add-to-playlist-modal 
      [media]="media()"
      (close)="showPlaylistModal.set(false)"
    />
}